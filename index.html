<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sound Monitor — Pro + FFT + Zoom + Reactive BG + Firebase</title>

  <!-- Chart.js + zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase (optional - uncomment when you paste your firebaseConfig) -->
  <!-- <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script> -->
  <!-- <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script> -->

  <style>
    :root{
      --bg-dark: #05060a;
      --card: rgba(255,255,255,0.03);
      --accent: #00f0ff;
      --accent2: #8a4cff;
      --ok: #39d98a;
      --warn: #ffd166;
      --danger: #ff4d6d;
      --muted: rgba(255,255,255,0.6);
      --glass: rgba(255,255,255,0.04);
      --radius: 12px;
    }
    body{
      margin:0;font-family:Inter,system-ui,Arial; background:var(--bg-dark);color:#eaf9fb;overflow:hidden;
    }
    /* full-screen reactive canvas behind UI */
    #bgCanvas{ position:fixed; inset:0; z-index:0; }
    .app{
      position:relative; z-index:2; padding:18px; display:grid; grid-template-columns:1fr; gap:14px; height:100vh; box-sizing:border-box;
    }
    @media(min-width:920px){ .app{ grid-template-columns:360px 1fr; } }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{ width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2)); display:grid;place-items:center;color:#000;font-weight:800;}
    h1{ margin:0; font-size:18px; }
    nav{ display:flex; gap:8px; align-items:center; }

    .card{ background:var(--card); border-radius:var(--radius); padding:14px; border:1px solid var(--glass); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .small{ font-size:13px; color:var(--muted); }

    /* controls */
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .btn{ padding:8px 12px; border-radius:10px; background:linear-gradient(90deg, rgba(0,240,255,0.12), rgba(138,76,255,0.08)); border:1px solid rgba(255,255,255,0.04); color:var(--accent); font-weight:700; cursor:pointer; }
    .btn.ghost{ background:transparent; border:1px dashed var(--glass); color:var(--muted); }

    /* gauge */
    .gauge-card{ display:flex; gap:12px; align-items:center; flex-direction:column; }
    .gauge-svg{ width:240px; height:120px; }
    .db-big{ font-size:28px; font-weight:800; color:var(--accent); }
    .gauge-center{ display:flex; flex-direction:column; align-items:center; gap:6px; }

    /* chart */
    .chart-box{ height:300px; }

    /* fft */
    .fft-box{ height:160px; margin-top:10px; }

    /* history */
    .history-list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:360px; overflow:auto; }

    /* footer small */
    footer{ margin-top:8px; color:var(--muted); font-size:13px; }

    /* top-left UI container */
    .left-column{ display:flex; flex-direction:column; gap:12px; }

    /* small badges */
    .badge{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); font-weight:700; color:var(--muted); }

    /* responsive small */
    @media(max-width:640px){
      .gauge-svg{ width:180px; height:90px; }
      .db-big{ font-size:22px; }
    }
  </style>
</head>
<body>

  <canvas id="bgCanvas"></canvas>

  <div class="app">
    <!-- LEFT -->
    <div class="left-column">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="brand"><div class="logo">SM</div><div><h1>Sound Monitor</h1><div class="small">Live • FFT • History</div></div></div>
          <div style="display:flex;gap:8px">
            <button id="startBtn" class="btn">Start</button>
            <button id="saveLocalBtn" class="btn ghost">Save</button>
          </div>
        </div>

        <div style="margin-top:12px" class="gauge-card">
          <svg class="gauge-svg" viewBox="0 0 240 120" preserveAspectRatio="xMidYMid meet">
            <!-- zones: green / yellow / red -->
            <path d="M20 100 A100 100 0 0 1 220 100" stroke="var(--ok)" stroke-width="14" fill="none" stroke-linecap="round" opacity="0.7"/>
            <path d="M40 100 A80 80 0 0 1 200 100" stroke="var(--warn)" stroke-width="14" fill="none" stroke-linecap="round" opacity="0.6"/>
            <path d="M60 100 A60 60 0 0 1 180 100" stroke="var(--danger)" stroke-width="14" fill="none" stroke-linecap="round" opacity="0.45"/>
            <!-- needle -->
            <g id="needle" transform="translate(120,100) rotate(-90)">
              <line x1="0" y1="0" x2="0" y2="-72" stroke="#fff" stroke-width="3" stroke-linecap="round" />
              <circle cx="0" cy="0" r="6" fill="#fff"></circle>
            </g>
            <!-- center label -->
            <text id="dbText" x="120" y="88" font-size="16" text-anchor="middle" fill="var(--accent)">-- dB</text>
          </svg>

          <div class="gauge-center">
            <div class="db-big" id="dbBig">-- dB</div>
            <div class="small">Current Level</div>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="small">Threshold</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="thresholdRange" type="range" min="30" max="120" value="60" />
            <div class="badge" id="thVal">60 dB</div>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <div class="small">Status</div>
          <div id="status" class="small">Idle</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between">
          <div>
            <div class="small">Max</div><div id="maxVal" style="font-weight:700">--</div>
          </div>
          <div>
            <div class="small">Min</div><div id="minVal" style="font-weight:700">--</div>
          </div>
          <div>
            <div class="small">Avg</div><div id="avgVal" style="font-weight:700">--</div>
          </div>
        </div>

        <footer>Tip: allow microphone on your phone for accurate readings.</footer>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">History</div><div style="font-weight:800">Saved Days</div></div>
          <div><button id="clearHistory" class="btn ghost">Clear All</button></div>
        </div>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">Live</div><div style="font-weight:800">Live Graph</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="graphModeBtn" class="btn">Mode: Fixed</button>
            <button id="zoomReset" class="btn ghost">Reset Zoom</button>
            <div class="small">Samples: <span id="countVal">0</span></div>
          </div>
        </div>

        <div style="margin-top:12px" class="chart-box">
          <canvas id="liveChart"></canvas>
        </div>

        <div style="margin-top:10px" class="fft-box card" id="fftCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="small">Frequency</div><div style="font-weight:800">FFT Spectrum</div></div>
            <div class="small">Bins: <span id="fftBins">--</span></div>
          </div>
          <canvas id="fftCanvas" height="120" style="width:100%;"></canvas>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button id="exportBtn" class="btn">Export PDF</button>
          <button id="uploadFirebaseBtn" class="btn ghost">Upload (Firebase)</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Reactive background canvas
   =========================== */
const bg = document.getElementById('bgCanvas');
const dpr = window.devicePixelRatio || 1;
function setupBG(){
  bg.width = innerWidth * dpr;
  bg.height = innerHeight * dpr;
  bg.style.width = innerWidth + 'px';
  bg.style.height = innerHeight + 'px';
}
setupBG();
window.addEventListener('resize', setupBG);
const bgCtx = bg.getContext('2d');
let particles = [];
for(let i=0;i<80;i++){
  particles.push({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r: Math.random()*2+1,
    vx: (Math.random()-0.5)*0.3,
    vy: (Math.random()-0.5)*0.3,
    hue: Math.random()*360
  });
}
let bgAmplitude = 0;
function drawBG(){
  bgCtx.clearRect(0,0,bg.width,bg.height);
  // subtle radial gradient
  const g = bgCtx.createRadialGradient(innerWidth*dpr*0.2, innerHeight*dpr*0.1, 0, innerWidth*dpr*0.5, innerHeight*dpr*0.6, Math.max(innerWidth,innerHeight)*dpr);
  g.addColorStop(0, 'rgba(0,240,255,0.02)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,bg.width,bg.height);
  particles.forEach(p=>{
    // move
    p.x += p.vx * (1+bgAmplitude*6);
    p.y += p.vy * (1+bgAmplitude*6);
    // wrap
    if(p.x < -50) p.x = innerWidth+50;
    if(p.x > innerWidth+50) p.x = -50;
    if(p.y < -50) p.y = innerHeight+50;
    if(p.y > innerHeight+50) p.y = -50;
    // draw
    const size = (p.r + 1 + bgAmplitude*8) * dpr;
    bgCtx.beginPath();
    bgCtx.fillStyle = `hsla(${p.hue}, 85%, 60%, ${0.06 + bgAmplitude*0.3})`;
    bgCtx.arc(p.x*dpr, p.y*dpr, size, 0, Math.PI*2);
    bgCtx.fill();
  });
  requestAnimationFrame(drawBG);
}
drawBG();

/* ===========================
   Audio & Analyser setup
   =========================== */
let audioCtx=null, analyser=null, freqAnalyser=null, sourceNode=null;
let dataArrayTime=null, dataArrayFreq=null;
let measuring=false, rafId=null;
let readings=[]; // numeric dB readings
let threshold = 60;
const SAMPLE_CHUNK = 2048;

const startBtn = document.getElementById('startBtn');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const exportBtn = document.getElementById('exportBtn');
const uploadFirebaseBtn = document.getElementById('uploadFirebaseBtn');
const thresholdRange = document.getElementById('thresholdRange');
const thValEl = document.getElementById('thVal');
const statusEl = document.getElementById('status');
const dbBig = document.getElementById('dbBig');
const dbText = document.getElementById('dbText');
const needle = document.getElementById('needle');
const maxValEl = document.getElementById('maxVal');
const minValEl = document.getElementById('minVal');
const avgValEl = document.getElementById('avgVal');
const countValEl = document.getElementById('countVal');
const fftBinsEl = document.getElementById('fftBins');

thresholdRange.addEventListener('input', ()=> {
  threshold = Number(thresholdRange.value);
  thValEl.innerText = threshold + ' dB';
});
thValEl.innerText = threshold + ' dB';

/* ===========================
   Chart: Live dB (with zoom/pan)
   =========================== */
const liveCtx = document.getElementById('liveChart').getContext('2d');
const liveChart = new Chart(liveCtx, {
  type:'line',
  data:{ labels:[], datasets:[{ label:'dB', data:[], borderColor:'rgba(11,243,222,0.95)', backgroundColor:'rgba(11,243,222,0.06)', tension:0.25, pointRadius:0, fill:true }]},
  options:{
    animation:false, responsive:true, maintainAspectRatio:false,
    scales:{ x:{ display:false }, y:{ min:0, max:120 } },
    plugins:{
      legend:{ display:false },
      zoom:{
        pan:{ enabled:true, mode:'x', modifierKey:'ctrl' },
        zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'x' }
      }
    }
  }
});
const graphModeBtn = document.getElementById('graphModeBtn');
const zoomReset = document.getElementById('zoomReset');
let graphMode = 'fixed'; // fixed | auto | compact
function applyGraphMode(){
  if(graphMode==='fixed'){ liveChart.options.scales.y.min = 0; liveChart.options.scales.y.max = 120; graphModeBtn.innerText='Mode: Fixed'; }
  else if(graphMode==='auto'){ const recent = readings.slice(-120); const maxVal = Math.max(...recent, 20); const minVal = Math.min(...recent, 0); liveChart.options.scales.y.min = Math.max(0, minVal-8); liveChart.options.scales.y.max = Math.min(140, maxVal+8); graphModeBtn.innerText='Mode: Auto'; }
  else if(graphMode==='compact'){ liveChart.options.scales.y.min = 0; liveChart.options.scales.y.max = 80; graphModeBtn.innerText='Mode: Compact'; }
  liveChart.update('none');
}
graphModeBtn.addEventListener('click', ()=>{ graphMode = graphMode==='fixed'?'auto': graphMode==='auto'?'compact':'fixed'; applyGraphMode(); });
zoomReset.addEventListener('click', ()=>{ if (liveChart.resetZoom) liveChart.resetZoom(); });

/* ===========================
   FFT Canvas
   =========================== */
const fftCanvas = document.getElementById('fftCanvas');
const fftCtx = fftCanvas.getContext('2d');
function resizeFFT(){ fftCanvas.width = fftCanvas.clientWidth * dpr; fftCanvas.height = fftCanvas.clientHeight * dpr; }
resizeFFT(); window.addEventListener('resize', resizeFFT);

/* ===========================
   FFT drawing routine
   =========================== */
function drawFFT(){
  if (!dataArrayFreq) { requestAnimationFrame(drawFFT); return; }
  fftCtx.clearRect(0,0,fftCanvas.width,fftCanvas.height);
  const w = fftCanvas.width, h = fftCanvas.height;
  const binCount = dataArrayFreq.length;
  const barWidth = w / binCount;
  fftCtx.fillStyle = 'rgba(255,255,255,0.04)';
  for(let i=0;i<binCount;i++){
    const v = dataArrayFreq[i] / 255; // 0..1
    const barH = v * h;
    // color gradient
    const hue = Math.round((i/binCount)*260);
    fftCtx.fillStyle = `hsl(${hue}, 80%, ${30 + v*40}%)`;
    fftCtx.fillRect(i*barWidth, h-barH, Math.max(1,barWidth-1), barH);
  }
  fftBinsEl.innerText = binCount;
  requestAnimationFrame(drawFFT);
}
drawFFT();

/* ===========================
   Main measurement loop
   =========================== */
async function startMonitoring(){
  if (measuring) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser(); // for time-domain RMS
    freqAnalyser = audioCtx.createAnalyser(); // for frequency domain
    analyser.fftSize = SAMPLE_CHUNK;
    freqAnalyser.fftSize = 1024; // smaller for smoother FFT
    dataArrayTime = new Float32Array(analyser.fftSize);
    dataArrayFreq = new Uint8Array(freqAnalyser.frequencyBinCount);

    sourceNode = audioCtx.createMediaStreamSource(stream);
    // split to two analysers
    const splitter = audioCtx.createChannelSplitter(1);
    sourceNode.connect(splitter);
    splitter.connect(analyser, 0);
    splitter.connect(freqAnalyser, 0);

    measuring = true;
    startBtn.innerText = 'Stop';
    statusEl.innerText = 'Monitoring';

    measureLoop();
    drawFFT();
  } catch(e){
    alert('Allow microphone access and reload the page.');
    console.error(e);
  }
}

function stopMonitoring(){
  measuring = false;
  startBtn.innerText = 'Start';
  statusEl.innerText = 'Stopped';
  if (rafId) cancelAnimationFrame(rafId);
  try{ if (audioCtx) audioCtx.suspend(); }catch(e){}
}

startBtn.addEventListener('click', ()=> { if(!measuring) startMonitoring(); else stopMonitoring(); });

function measureLoop(){
  if(!measuring) return;
  // time domain RMS
  analyser.getFloatTimeDomainData(dataArrayTime);
  let sum = 0;
  for(let i=0;i<dataArrayTime.length;i++) sum += dataArrayTime[i]*dataArrayTime[i];
  let rms = Math.sqrt(sum / dataArrayTime.length);
  let dB = 20 * Math.log10(Math.max(rms, 1e-8)); // negative dBFS
  let dbPos = Math.round((dB + 100) * 1.15); // map to positive approximate
  dbPos = Math.max(0, Math.min(140, dbPos));

  // frequency domain
  freqAnalyser.getByteFrequencyData(dataArrayFreq);

  // update bg amplitude (0..1)
  bgAmplitude = Math.min(1, rms * 80);

  // update UI
  handleReading(dbPos);

  // FFT array for drawing
  dataArrayFreq = dataArrayFreq;

  rafId = requestAnimationFrame(measureLoop);
}

/* ===========================
   UI update & chart push
   =========================== */
function handleReading(db){
  // readings store
  readings.push(db);
  if(readings.length>2000) readings.shift();

  // gauge + needle
  dbBig.innerText = db + ' dB';
  dbText.innerText = db + ' dB';
  const angle = ((Math.max(0,Math.min(120,db)) / 120) * 180) - 90;
  needle.setAttribute('transform', `translate(120,100) rotate(${angle})`);

  // summary numbers
  const max = Math.max(...readings);
  const min = Math.min(...readings);
  const avg = Math.round(readings.reduce((a,b)=>a+b,0)/readings.length);
  maxValEl.innerText = max;
  minValEl.innerText = min;
  avgValEl.innerText = avg;
  countValEl.innerText = readings.length;

  // push to chart (stable chart Y-range maintained by applyGraphMode)
  liveChart.data.labels.push('');
  liveChart.data.datasets[0].data.push(db);
  if (liveChart.data.labels.length > 300){
    liveChart.data.labels.shift();
    liveChart.data.datasets[0].data.shift();
  }
  applyGraphMode();

  // alert logic & color feedback
  if (db >= threshold){
    statusEl.innerText = `ALERT: ${db} dB`;
    statusEl.style.color = 'var(--danger)';
    // quick header flash
    document.querySelector('header')?.animate([{ boxShadow: '0 8px 30px rgba(255,77,109,0.08)' }, { boxShadow: '' }], { duration: 600 });
    if (navigator.vibrate) navigator.vibrate(120);
  } else {
    statusEl.innerText = 'Monitoring';
    statusEl.style.color = '';
  }
}

/* ===========================
   Save & history (local) + export
   =========================== */
function saveSessionLocal(){
  if (!readings.length) return null;
  const key = new Date().toISOString().slice(0,10);
  const store = JSON.parse(localStorage.getItem('sm_history') || '{}');
  store[key] = store[key] || [];
  // push last 1000 values with timestamps approx spaced
  const base = Date.now();
  const list = readings.slice(-1000).map((v,i)=>({ t: base - (readings.length - i)*200, db: v }));
  store[key] = store[key].concat(list);
  localStorage.setItem('sm_history', JSON.stringify(store));
  renderHistory();
  return key;
}
saveLocalBtn.addEventListener('click', ()=> {
  const k = saveSessionLocal();
  if (k) alert('Saved session for ' + k);
  else alert('No data yet');
});

function renderHistory(){
  const store = JSON.parse(localStorage.getItem('sm_history') || '{}');
  const days = Object.keys(store).sort((a,b)=>b.localeCompare(a));
  const container = document.getElementById('historyList');
  container.innerHTML = '';
  if (!days.length) { container.innerHTML = '<div class="small">No saved days yet.</div>'; return; }
  days.forEach(day=>{
    const arr = store[day];
    const avg = Math.round(arr.reduce((a,b)=>a+b.db,0)/arr.length);
    const item = document.createElement('div');
    item.className = 'history-item';
    item.style.display='flex';
    item.style.justifyContent='space-between';
    item.style.alignItems='center';
    item.style.padding='8px';
    item.style.border='1px solid var(--glass)';
    item.style.borderRadius='8px';
    item.innerHTML = `<div><strong>${day}</strong><div class="small">Samples: ${arr.length} • Avg: ${avg} dB</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" data-day="${day}" data-action="view">View</button>
        <button class="btn ghost" data-day="${day}" data-action="pdf">PDF</button>
        <button class="btn ghost" data-day="${day}" data-action="delete">Delete</button>
      </div>`;
    container.appendChild(item);
  });
  container.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', (e)=>{
      const action = b.dataset.action, day = b.dataset.day;
      const store = JSON.parse(localStorage.getItem('sm_history') || '{}');
      if (action==='view'){
        const arr = store[day].map(x=>x.db);
        liveChart.data.labels = arr.map(_=>'');
        liveChart.data.datasets[0].data = arr;
        liveChart.update();
      } else if(action==='pdf'){
        const arr = store[day].map(x=>x.db);
        exportPDFForReadings(arr, day);
      } else if(action==='delete'){
        if(confirm('Delete '+day+' ?')){ delete store[day]; localStorage.setItem('sm_history', JSON.stringify(store)); renderHistory(); }
      }
    });
  });
}
renderHistory();

document.getElementById('clearHistory').addEventListener('click', ()=>{
  if(confirm('Clear all saved history?')){ localStorage.removeItem('sm_history'); renderHistory(); }
});

// export pdf
exportBtn.addEventListener('click', ()=> exportPDFForReadings(readings, 'live'));
function exportPDFForReadings(arr, dateKey){
  if (!arr || !arr.length){ alert('No data'); return; }
  const max = Math.max(...arr), min=Math.min(...arr), avg=Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm',format:'a4'});
  doc.setFontSize(16); doc.setTextColor(10,200,220); doc.text('Sound Report',14,18);
  doc.setFontSize(11); doc.setTextColor(160,160,160); doc.text('Date: '+dateKey,14,28);
  doc.setFontSize(12); doc.setTextColor(255,255,255);
  doc.text(`Max: ${max} dB`,14,42); doc.text(`Min: ${min} dB`,14,50); doc.text(`Avg: ${avg} dB`,14,58); doc.text(`Samples: ${arr.length}`,14,66);
  try{
    const img = document.getElementById('liveChart').toDataURL('image/png',1.0);
    doc.addImage(img,'PNG',14,76,180,60);
  }catch(e){ console.warn('chart export failed', e); }
  doc.save('sound_report_'+dateKey+'.pdf');
}

/* ===========================
   FFT draw should use dataArrayFreq
   =========================== */
function updateFFTArray(){
  if (!freqAnalyser) return;
  const arr = new Uint8Array(freqAnalyser.frequencyBinCount);
  freqAnalyser.getByteFrequencyData(arr);
  dataArrayFreq = arr;
}
function fftLoop(){
  if(!measuring){ requestAnimationFrame(fftLoop); return; }
  updateFFTArray();
  // draw handled in drawFFT() which uses dataArrayFreq
  requestAnimationFrame(fftLoop);
}
fftLoop();

/* ===========================
   Firebase optional upload (outline)
   =========================== */
// To enable Firebase:
// 1) Uncomment Firebase <script> tags at the top of this file.
// 2) Paste your firebaseConfig object into firebaseConfig variable below.
// 3) Uncomment firebase.initializeApp(firebaseConfig); and related code.
// 4) Call enableFirebase() to start using cloud saves.

let firebaseEnabled = false;
let firebaseEnv = null;
// Example place to add firebaseConfig:
const firebaseConfig = {
  /* paste your Firebase config here:
  apiKey: "...",
  authDomain: "...",
  databaseURL: "https://<your-db>.firebaseio.com",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
  */
};

// function enableFirebase(){
//   if(typeof firebase === 'undefined'){ alert('Firebase SDK is not loaded. Uncomment imports in the HTML and add your config.'); return; }
//   firebase.initializeApp(firebaseConfig);
//   firebaseEnv = firebase.database();
//   firebaseEnabled = true;
//   alert('Firebase enabled (ready to upload).');
// }

uploadFirebaseBtn.addEventListener('click', async ()=>{
  if(!firebaseEnabled){ alert('Firebase not enabled. See code comments to enable.'); return; }
  // example payload
  const key = new Date().toISOString().slice(0,10);
  const payload = readings.map((v,i)=>({ t: Date.now() - (readings.length - i)*250, db: v }));
  try{
    // firebaseEnv.ref('sound_data/'+key).push(payload);
    alert('Uploaded to Firebase (example code commented)');
  }catch(e){ console.error(e); alert('Upload failed'); }
});

/* ===========================
   Graph mode & apply
   =========================== */
function applyGraphMode(){
  if(graphMode==='fixed'){ liveChart.options.scales.y.min = 0; liveChart.options.scales.y.max = 120; graphModeBtn.innerText = 'Mode: Fixed'; }
  else if(graphMode==='auto'){ const recent = readings.slice(-120); const maxVal = Math.max(...recent, 20); const minVal = Math.min(...recent, 0); liveChart.options.scales.y.min = Math.max(0, minVal-8); liveChart.options.scales.y.max = Math.min(140, maxVal+8); graphModeBtn.innerText='Mode: Auto'; }
  else if(graphMode==='compact'){ liveChart.options.scales.y.min = 0; liveChart.options.scales.y.max = 80; graphModeBtn.innerText='Mode: Compact'; }
  liveChart.update('none');
}
graphModeBtn.addEventListener('click', ()=> { graphMode = graphMode==='fixed'?'auto': graphMode==='auto'?'compact':'fixed'; applyGraphMode(); });
// initial
applyGraphMode();

/* ===========================
   small startup UX
   =========================== */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && measuring && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
});

// Prevent mic locked on unload
window.addEventListener('beforeunload', ()=> { try{ if (audioCtx) audioCtx.close(); }catch(e){} });

/* ===========================
   Start background FFT draw + BG amplitude smoothing
   =========================== */
let smoothAmp = 0;
function bgAmpLoop(){
  // smooth
  smoothAmp += (bgAmplitude - smoothAmp) * 0.08;
  bgAmplitude = smoothAmp;
  requestAnimationFrame(bgAmpLoop);
}
bgAmpLoop();

// use drawFFT() to paint using dataArrayFreq (update already started earlier)
(function fftPainter(){
  if (dataArrayFreq && dataArrayFreq.length){
    // draw happens in drawFFT() which references dataArrayFreq currently
  }
  requestAnimationFrame(fftPainter);
})();

// ensure drawFFT reads the current dataArrayFreq variable
// (the drawFFT function is already scheduled at init)

/* ===========================
   Kick off background painter that also uses amplitude to adjust particles
   =========================== */
(function bgTicker(){
  // slightly tweak particle properties based on amplitude
  particles.forEach(p=>{
    p.vx += (Math.random()-0.5)*0.02 * (1 + bgAmplitude*6);
    p.vy += (Math.random()-0.5)*0.02 * (1 + bgAmplitude*6);
    p.hue += 0.1 + bgAmplitude*2;
  });
  drawBG();
  requestAnimationFrame(bgTicker);
})();

</script>
</body>
</html>

