<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Sound Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg: #05060a;
      --card: rgba(255,255,255,0.03);
      --neon: #00f0ff;
      --danger: #ff4d6d;
      --muted: rgba(255,255,255,0.5);
      --glass-border: rgba(255,255,255,0.06);
      --radius: 14px;
    }
    body{
      margin:0;
      min-height:100vh;
      background:#05060a;
      color:#e9f7fb;
      font-family: Inter, system-ui;
      padding:20px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      border:1px solid var(--glass-border);
      box-shadow:0 6px 30px rgba(0,0,0,0.5);
      margin-bottom:20px;
    }
    .gauge-ring{
      width:160px;height:160px;border-radius:50%;
      background:conic-gradient(var(--neon) 0deg, rgba(255,255,255,0.06) 0deg);
      display:grid;place-items:center;
    }
    .gauge-center{
      width:120px;height:120px;border-radius:50%;
      background:rgba(255,255,255,0.03);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
    }
    .dbVal{font-size:32px;font-weight:800;color:var(--neon)}
    button{
      padding:10px 18px;
      border-radius:10px;
      border:none;
      background:var(--neon);
      color:#000;font-weight:700;
      cursor:pointer;
    }
    #alertBox{
      background:rgba(255,77,109,0.2);
      padding:12px;
      margin-top:8px;
      border-radius:10px;
      border:1px solid rgba(255,77,109,0.4);
      display:none;
      font-weight:bold;
      color:var(--danger);
    }
  </style>
</head>
<body>

<h2 style="color:var(--neon)">Neon Sound Dashboard</h2>
<p class="muted">Live mic • Real-time dB • Stable graph • Alerts</p>

<div class="card">
  <button id="startBtn">Start Monitoring</button>

  <div style="margin-top:20px;display:flex;justify-content:center;">
    <div class="gauge-ring" id="gaugeRing">
      <div class="gauge-center">
        <div class="dbVal" id="dbVal">-- dB</div>
        <div style="font-size:13px;color:var(--muted)">Current Level</div>
      </div>
    </div>
  </div>

  <div id="alertBox">THRESHOLD EXCEEDED</div>

  <div style="margin-top:20px;">
    <label>Threshold: <span id="thVal">60</span>dB</label>
    <input type="range" min="30" max="120" value="60" id="threshold">
  </div>

</div>

<div class="card">
  <h3 style="color:var(--neon)">Live Graph</h3>
  <canvas id="chartCanvas" height="200"></canvas>
</div>

<script>

let audioCtx, analyser, dataArray;
let measuring = false;
let readings = [];
let threshold = 60;

// UI elements
const startBtn = document.getElementById("startBtn");
const dbVal = document.getElementById("dbVal");
const thVal = document.getElementById("thVal");
const thresholdSlider = document.getElementById("threshold");
const gaugeRing = document.getElementById("gaugeRing");
const alertBox = document.getElementById("alertBox");

// Fixed Y-axis graph
const ctx = document.getElementById("chartCanvas").getContext("2d");
const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      data: [],
      borderColor: "#00f0ff",
      backgroundColor: "rgba(0,240,255,0.12)",
      borderWidth: 2,
      tension: 0.4,
      pointRadius: 0,
      fill:true
    }]
  },
  options:{
    responsive:true,
    animation:false,
    scales:{
      x:{ display:false },
      y:{
        min:0,
        max:120,   // FIXED RANGE (no more expansion)
        ticks:{ color:"#fff" }
      }
    },
    plugins:{ legend:{ display:false } }
  }
});

// Start/Stop Monitoring
startBtn.onclick = () => {
  if (!measuring) startMonitoring();
  else stopMonitoring();
};

async function startMonitoring(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;

    const src = audioCtx.createMediaStreamSource(stream);
    src.connect(analyser);
    dataArray = new Float32Array(analyser.fftSize);

    measuring = true;
    startBtn.innerText = "Stop";
    measureLoop();

  }catch(e){
    alert("Allow microphone to start.");
  }
}

function stopMonitoring(){
  measuring = false;
  startBtn.innerText = "Start Monitoring";
}

function measureLoop(){
  if (!measuring) return;

  analyser.getFloatTimeDomainData(dataArray);
  let sum=0;
  for (let i=0;i<dataArray.length;i++) sum+=dataArray[i]*dataArray[i];

  let rms = Math.sqrt(sum/dataArray.length);
  let dB = 20*Math.log10(Math.max(rms, 1e-8));
  let dbPos = Math.round((dB + 100) * 1.2);
  dbPos = Math.max(0, Math.min(120, dbPos));

  updateUI(dbPos);
  requestAnimationFrame(measureLoop);
}

function updateUI(db){
  dbVal.innerText = db + " dB";

  const deg = (db/120)*360;
  gaugeRing.style.background =
    `conic-gradient(#00f0ff ${deg}deg, rgba(255,255,255,0.06) ${deg}deg)`;

  readings.push(db);

  if (readings.length>150){
    readings.shift();
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }

  chart.data.labels.push("");
  chart.data.datasets[0].data.push(db);
  chart.update("none");

  if (db >= threshold){
    alertBox.style.display="block";
    if (navigator.vibrate) navigator.vibrate(120);
  } else {
    alertBox.style.display="none";
  }
}

thresholdSlider.oninput = () => {
  threshold = Number(thresholdSlider.value);
  thVal.innerText = threshold;
};

</script>

</body>
</html>
