<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Sound Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg: #05060a;
      --card: rgba(255,255,255,0.03);
      --neon: #00f0ff;
      --danger: #ff4d6d;
      --muted: rgba(255,255,255,0.5);
      --glass-border: rgba(255,255,255,0.06);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
      background: #05060a;
      color: #e9f7fb;
      padding:20px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    h1{font-size:18px;margin:0;color:#00f0ff}
    p.subtitle{margin:0;color:var(--muted);font-size:13px}

    .container{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media(min-width:880px){
      .container{grid-template-columns: 450px 1fr}
    }

    .card{
      background:var(--card);
      border-radius: var(--radius);
      padding:16px;
      border:1px solid var(--glass-border);
      backdrop-filter: blur(6px);
    }

    .gauge {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .gauge-ring{
      width:160px;height:160px;border-radius:50%;
      background: conic-gradient(#00f0ff 0deg, rgba(255,255,255,0.06) 0deg);
      display:grid;place-items:center;
    }
    .gauge-center{
      width:120px;height:120px;border-radius:50%;
      background:rgba(255,255,255,0.03);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.04);
    }
    .dbVal{font-size:32px;font-weight:700;color:#00f0ff}
    .dbLabel{font-size:12px;color:var(--muted)}

    .alerts .alert{
      margin-top:10px;
      padding:12px;border-radius:10px;
      background:rgba(255,77,109,0.15);
      border:1px solid rgba(255,77,109,0.3);
      color:#ff4d6d;
      font-weight:700;
    }

    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:12px}
  </style>
</head>
<body>

<header>
  <div>
    <h1>Neon Sound Dashboard</h1>
    <p class="subtitle">Real-time sound analysis</p>
  </div>
  <button id="btnStart" style="padding:10px 18px;background:#00f0ff;border:none;border-radius:10px;font-weight:600;color:#000">
    Start Monitoring
  </button>
</header>

<main class="container">

  <!-- LEFT CARD -->
  <section class="card">
    <div class="gauge">
      <div class="gauge-ring" id="gaugeRing">
        <div class="gauge-center">
          <div class="dbVal" id="dbValue">-- dB</div>
          <div class="dbLabel">Current Level</div>
        </div>
      </div>

      <div style="flex:1;padding-left:10px">
        <label style="color:var(--muted);font-size:14px">Threshold</label>
        <input id="thresholdInput" type="range" min="30" max="120" value="60" style="width:100%">
        <span id="thVal" style="color:#00f0ff">60</span> dB

        <div class="alerts" id="alertsPanel">
          <p style="color:var(--muted)">Status: <span id="statusText">Idle</span></p>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-size:14px">
          <p>Max: <span id="maxVal" style="color:#00f0ff">--</span></p>
          <p>Min: <span id="minVal" style="color:#00f0ff">--</span></p>
          <p>Avg: <span id="avgVal" style="color:#00f0ff">--</span></p>
          <p>Samples: <span id="countVal" style="color:#00f0ff">0</span></p>
        </div>
      </div>
    </div>

    <footer>Allow microphone on phone for best accuracy</footer>
  </section>

  <!-- RIGHT CARD (GRAPH) -->
  <section class="card">
    <h3 style="margin:0 0 10px;color:#00f0ff">Live Graph</h3>
    <canvas id="chartCanvas" height="260"></canvas>
  </section>

</main>

<script>
/* -------------------------------
   JAVASCRIPT SECTION
--------------------------------*/

let audioCtx = null;
let analyser = null;
let dataArray = null;
let measuring = false;
let readings = [];
let threshold = 60;

const SAMPLE_RATE_MS = 200;

// UI elements
const btnStart = document.getElementById("btnStart");
const dbValueEl = document.getElementById("dbValue");
const gaugeRing = document.getElementById("gaugeRing");
const thresholdInput = document.getElementById("thresholdInput");
const thVal = document.getElementById("thVal");
const alertsPanel = document.getElementById("alertsPanel");
const statusText = document.getElementById("statusText");
const maxValEl = document.getElementById("maxVal");
const minValEl = document.getElementById("minVal");
const avgValEl = document.getElementById("avgVal");
const countValEl = document.getElementById("countVal");

// Chart.js setup
const ctx = document.getElementById("chartCanvas").getContext("2d");
const chart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "dB",
            data: [],
            borderColor: "#00f0ff",
            backgroundColor: "rgba(0,240,255,0.15)",
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 0,
            fill: true
        }]
    },
    options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { display: false },
            y: {
                suggestedMin: 0,
                suggestedMax: 120,
                ticks: { color: "#fff" }
            }
        },
        plugins: { legend: { display: false } }
    }
});

/* -------------------------------
   START / STOP MONITORING
--------------------------------*/
btnStart.addEventListener("click", () => {
    if (!measuring) startMonitoring();
    else stopMonitoring();
});

async function startMonitoring() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();

        analyser.fftSize = 2048;
        dataArray = new Float32Array(analyser.fftSize);

        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);

        measuring = true;
        btnStart.innerText = "Stop Monitoring";
        statusText.innerText = "Monitoring";

        measureLoop();

    } catch (err) {
        alert("Allow microphone access for the website to work.");
        console.error(err);
    }
}

function stopMonitoring() {
    measuring = false;
    statusText.innerText = "Stopped";
    btnStart.innerText = "Start Monitoring";
}

/* -------------------------------
   MAIN MEASUREMENT LOOP
--------------------------------*/
function measureLoop() {
    if (!measuring) return;

    analyser.getFloatTimeDomainData(dataArray);

    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];

    let rms = Math.sqrt(sum / dataArray.length);
    let dB = 20 * Math.log10(Math.max(rms, 1e-8));

    let dbPos = Math.round((dB + 100) * 1.2); // approx positive range
    dbPos = Math.max(0, Math.min(140, dbPos));

    updateUI(dbPos);

    requestAnimationFrame(measureLoop);
}

/* -------------------------------
   UPDATE UI & CHART
--------------------------------*/
function updateUI(db) {
    // text
    dbValueEl.innerText = db + " dB";

    // gauge ring
    const deg = (db / 120) * 360;
    gaugeRing.style.background = `conic-gradient(#00f0ff ${deg}deg, rgba(255,255,255,0.06) ${deg}deg)`;

    // alert logic
    if (db >= threshold) showAlert("Threshold Exceeded: " + db + " dB");
    else clearAlert();

    // summary calculations
    readings.push(db);
    maxValEl.innerText = Math.max(...readings);
    minValEl.innerText = Math.min(...readings);
    avgValEl.innerText = Math.round(readings.reduce((a,b)=>a+b,0) / readings.length);
    countValEl.innerText = readings.length;

    // chart update
    chart.data.labels.push("");
    chart.data.datasets[0].data.push(db);
    if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update("none");
}

/* -------------------------------
   ALERT SYSTEM
--------------------------------*/
let alertShown = false;

function showAlert(msg) {
    if (!alertShown) {
        let div = document.createElement("div");
        div.className = "alert";
        div.innerText = msg;
        alertsPanel.appendChild(div);
        alertShown = true;
    }
}

function clearAlert() {
    if (alertShown) {
        alertsPanel.innerHTML = `<p style="color:var(--muted)">Status: <span id="statusText">Monitoring</span></p>`;
        alertShown = false;
    }
}

/* -------------------------------
   THRESHOLD CONTROL
--------------------------------*/
thresholdInput.addEventListener("input", () => {
    threshold = Number(thresholdInput.value);
    thVal.innerText = threshold;
});
</script>

</body>
</html>

